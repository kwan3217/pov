// JupiterSat.inc
// Orbital Motions of Galilean and inner satellites of Jupiter
// Derived from orbital elements and formulas given in
//   The Explanatory Supplement to the Astronomical Almanac, p345-349

//  Position is returned in units of km, centered on the jupiter barycenter, J2000 ecliptic

#macro Rx(V,Theta)
  (vrotate(V,<Theta,0,0>))
#end

#macro Ry(V,Theta)
  (vrotate(V,<0,Theta,0>))
#end

#macro Rz(V,Theta)
  (vrotate(V,<0,0,Theta>))
#end

#macro CalcJupiterSatPos(Sat,TT)
  #local T=TT-43000.5;
  #local SS=Sat-1;
  //Semimajor Axes
  #local JupiterSatA=array[4]  {0.002819347,0.004485872,0.007155352,0.012585436}
  //Mean Longitudes
  #local JupiterSatL=array[4]  {106.0785900+203.4889553630643*T,
                      175.7337870+101.3747245566245*T,
                      120.5613855+ 50.31760915340462*T,
                       84.4558230+ 21.57107087517961*T}
  //Proper Periapses
  #local JupiterSatP=array[4]  { 82.380231+0.16102275*T,
                      128.960393+0.04645644*T,
                      187.550171+0.00712408*T,
                      335.309254+0.00183939*T}
  //Proper Nodes
  #local JupiterSatTheta=array[4] {308.365749-0.13280610*T,
                         100.438938-0.03261535*T,
                         118.908928-0.00717678*T,
                         322.746564-0.00176018*T}
  //Libration Phase Angle
  #local PhiL=184.415351+0.17356902*T;
  //Longitude of Perihelion of Jupiter
  #local PiJ=13.470395;
  //Longitude of Jupiter's Pole
  #local Psi=316.500101-0.00000248*T;
  //Mean Anomaly of Saturn
  #local GPrime=31.9785280244+0.033459733896*T;
  //Mean Anomaly of Jupiter
  #local G=30.2380210168+0.08309256178969453*T;
  //Phase Angle
  #local Phi2=52.1445966929;

  #local XiLen=array[4] {1,3,3,6}
  #local XiTable=array[4][6][11] {
    //Amp           L     |     P
    //         1  2  3  4  1  2  3  4  PiJ  G
  { //Io
   {-41279,    2,-2, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0}
  },
  { //Europa
   {- 3187,    0, 1, 0, 0, 0, 0,-1, 0,   0, 0},
   {- 1738,    0, 1, 0, 0, 0, 0, 0,-1,   0, 0},
   {+93748,    1,-1, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0}
  },
  { //Ganymede
   {-14691,    0, 0, 1, 0, 0, 0,-1, 0,   0, 0},
   {- 1758,    0, 0, 2,-2, 0, 0, 0, 0,   0, 0},
   {+ 6333,    0, 1, 1, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0},
   {     0,    0, 0, 0, 0, 0, 0, 0, 0,   0, 0}
  },
  { //Callisto
   { +1656,    0, 0, 0, 1, 0, 0,-1, 0,   0, 0},
   {-73328,    0, 0, 0, 1, 0, 0, 0,-1,   0, 0},
   {  +182,    0, 0, 0, 1, 0, 0, 0, 0,  -1, 0},
   {  -541,    0, 0, 0, 1, 0, 0, 0, 1,  -2,-2},
   {  -269,    0, 0, 0, 2, 0, 0, 0,-2,   0, 0},
   {  +974,    0, 0, 1,-1, 0, 0, 0, 0,   0, 0}
  }}

  #local NuLen=array[4] {6,15,17,22}
  #local NuTable=array[4][22][19] {
     //Amp        L     |     P     |   Theta   |
     //      1  2  3  4  1  2  3  4  1  2  3  4  PiJ  G  Psi  PhiL  GPrime  Phi2
  { //Io
   {-  5596, 0, 0, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  2198, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0,  -2,-2,   0,    0,      0,    0},
   {+  1321, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    1,      0,    0},
   {-  1157, 1,-2, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  1940, 1,-2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+ 82363, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
  },
  { //Europa
   {-  1158, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  -2, 0,  -2,    0,      0,    0},
   {+  1715, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,  -2,-2,   1,    0,      0,    0},
   {-  1846, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 1,   0,    0,      0,    0},
   {+  2397, 0, 0, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  3172, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    1,      0,    0},
   {-  1993, 0, 1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  1884, 0, 1, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  6394, 0, 1, 0, 0, 0, 0,-1, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  3451, 0, 1, 0, 0, 0, 0, 0,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  4159, 1,-2, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  7571, 1,-2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  1491, 1,-2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-185640, 1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-   803, 1, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   915, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
  },
  { //Ganymede
   {-  1488, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   2, 0,   2,    0,      0,    0},
   {+   411, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1, 0,   0, 0,   1,    0,      0,    0},
   {+   346, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,   0, 0,   0,    0,      0,    0},
   {-  2338, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 1,   0,    0,      0,    0},
   {+  6558, 0, 0, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   523, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0,  -2,-2,   0,    0,      0,    0},
   {+   314, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    1,      0,    0},
   {-   943, 0, 0, 1,-1, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+ 29387, 0, 0, 1, 0, 0, 0,-1, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+ 15800, 0, 0, 1, 0, 0, 0, 0,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+  3218, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   226, 0, 0, 3,-2, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {- 12038, 0, 1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-   662, 1,-2, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  1246, 1,-2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   699, 1,-2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   217, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
  }
     //Amp        L     |     P     |   Theta   |
     //      1  2  3  4  1  2  3  4  1  2  3  4  PiJ  G  Psi  PhiL  GPrime  Phi2
  { //Callisto
   {-   407, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0, 0,   0, 0,  -2,    0,      0,    0},
   {+   309, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0, 1,   0, 0,   1,    0,      0,    0},
   {-  4840, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  -2, 0,   0,    0,      0,    0},
   {+  2074, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,   0, 0,   1,    0,      0,    0},
   {-  5605, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 1,   0,    0,      0,    0},
   {-   204, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 2,   0,    0,      0,    0},
   {-   495, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,-2,   0,    0,      5,    1},
   {+   234, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,  -1, 0,   0,    0,      0,    0},
   {-  6112, 0, 0, 0, 0, 0, 0, 1,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-  3318, 0, 0, 0, 1, 0, 0,-1, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+145573, 0, 0, 0, 1, 0, 0, 0,-1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   178, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,  -1,-1,   0,    0,      0,    0},
   {-   363, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,  -1, 0,   0,    0,      0,    0},
   {+  1085, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0,  -2,-2,   0,    0,      0,    0},
   {+   672, 0, 0, 0, 2, 0, 0, 0,-2, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   218, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0,  -2,-2,   0,    0,      0,    0},
   {+   167, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0,-1,   0, 0,  -1,    0,      0,    0},
   {-   142, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,  -2,    0,      0,    0},
   {+   148, 0, 0, 1,-2, 0, 0, 0, 1, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-   390, 0, 0, 1,-1, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {-   195, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
   {+   185, 0, 0, 3,-7, 0, 0, 0, 4, 0, 0, 0, 0,   0, 0,   0,    0,      0,    0},
  }}

  #local ZetaLen=array[4] {2,3,4,4}
  #local ZetaTable=array[4][4][13] {
  {//Io
     //Amp        L     |   Theta   |
     //      1  2  3  4  1  2  3  4  Nu PiJ  G  Psi
   {+  7038, 1, 0, 0, 0,-1, 0, 0, 0,  1,  0, 0,   0},
   {+  1835, 1, 0, 0, 0, 0,-1, 0, 0,  1,  0, 0,   0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0,   0},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0,   0},
  },
  { //Europa
   {+ 81575, 0, 1, 0, 0, 0,-1, 0, 0,  1,  0, 0,   0},
   {+  4512, 0, 1, 0, 0, 0, 0,-1, 0,  1,  0, 0,   0},
   {-  3286, 0, 1, 0, 0, 0, 0, 0, 0,  1,  0, 0,  -1},
   {      0, 0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0,   0},
  },
  { //Ganymede
   {-  2793, 0, 0, 1, 0, 0,-1, 0, 0,  1,  0, 0,   0},
   {+ 32378, 0, 0, 1, 0, 0, 0,-1, 0,  1,  0, 0,   0},
   {+  6871, 0, 0, 1, 0, 0, 0, 0,-1,  1,  0, 0,   0},
   {- 16876, 0, 0, 1, 0, 0, 0, 0, 0,  1,  0, 0,  -1},
  },
  { //Callisto
   {+   773, 0, 0, 0, 1, 0, 0, 0, 0,  1, -2, 1,   1},
   {-  5075, 0, 0, 0, 1, 0, 0,-1, 0,  1,  0, 0,   0},
   {+ 44300, 0, 0, 0, 1, 0, 0, 0,-1,  1,  0, 0,   0},
   {- 76493, 0, 0, 0, 1, 0, 0, 0, 0,  0,  0, 0,   1},
  }}



  #local Xi=0;
  #local I=0;
  #while(I<XiLen[SS])
    #local Arg=XiTable[SS][I][ 9]*PiJ
              +XiTable[SS][I][10]*G;
    #local J=0;
    #while(J<4)
      #local Arg=Arg+XiTable[SS][I][1+J]*JupiterSatL[J]
                    +XiTable[SS][I][5+J]*JupiterSatP[J];
      #local J=J+1;
    #end
    #local Xi=Xi+XiTable[SS][I][0]*CosD(Arg);
    #local I=I+1;
  #end
  #local Nu=0;
  #local I=0;
  #while(I<NuLen[SS])
    #local Arg=NuTable[SS][I][13]*PiJ
              +NuTable[SS][I][14]*G
              +NuTable[SS][I][15]*Psi
              +NuTable[SS][I][16]*PhiL
              +NuTable[SS][I][17]*GPrime
              +NuTable[SS][I][18]*Phi2;
    #local J=0;
    #while(J<4)
      #local Arg=Arg+NuTable[SS][I][1+J]*JupiterSatL[J]
                    +NuTable[SS][I][5+J]*JupiterSatP[J]
                    +NuTable[SS][I][9+J]*JupiterSatTheta[J];
      #local J=J+1;
    #end
    #local Nu=Nu+NuTable[SS][I][0]*SinD(Arg);
    #local I=I+1;
  #end
  #local Zeta=0;
  #local I=0;
  #while(I<ZetaLen[SS])
    #local Arg=ZetaTable[SS][I][9]*Nu
              +ZetaTable[SS][I][10]*PiJ
              +ZetaTable[SS][I][11]*G
              +ZetaTable[SS][I][12]*Psi;
    #local J=0;
    #while(J<4)
      #local Arg=Arg+ZetaTable[SS][I][1+J]*JupiterSatL[J]
                    +ZetaTable[SS][I][5+J]*JupiterSatTheta[J];
      #local J=J+1;
    #end
    #local Zeta=Zeta+ZetaTable[SS][I][0]*SinD(Arg);
    #local I=I+1;
  #end
  #local R=JupiterSatA[SS]*<(1+Xi/1e7)*CosD(JupiterSatL[SS]-Psi+Nu/1e7),
                   Zeta/1e7,
                   (1+Xi/1e7)*SinD(JupiterSatL[SS]-Psi+Nu/1e7)>;
  #local Omega=100.55615;  // J2000
  #local J=1.30530;        // J2000
  #local Phi=Psi-Omega;
  #local I=3.10401;
  #local R=Rx(R,-I);
  #local R=Ry(R,-Phi);
  #local R=Rx(R,-J);
  #local R=Ry(R,-Omega);
  (R/KmtoAU(1))
#end

